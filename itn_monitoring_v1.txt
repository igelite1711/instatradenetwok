# ============================================
# InstantTrade Network - Monitoring Configuration
# ============================================
# Includes:
# 1. Prometheus configuration
# 2. Grafana dashboards
# 3. Alerting rules
# 4. SLO definitions
# ============================================

# ============================================
# PROMETHEUS CONFIGURATION
# ============================================
# File: monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'instanttrade-prod'
    env: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules
rule_files:
  - /etc/prometheus/rules/*.yml

# Scrape configurations
scrape_configs:
  # InstantTrade API
  - job_name: 'itn-api'
    static_configs:
      - targets: ['api:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  # PostgreSQL
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # Node metrics
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

  # Kubernetes pods
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__

---
# ============================================
# PROMETHEUS ALERT RULES
# ============================================
# File: monitoring/rules/alerts.yml
groups:
  - name: InstantTrade Critical
    interval: 30s
    rules:
      # System health score
      - alert: SystemHealthScoreLow
        expr: itn_health_score < 0.95
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "System health score below threshold"
          description: "Health score is {{ $value }}, threshold is 0.95. Multiple invariant failures detected."
      
      # Invariant violations
      - alert: InvariantViolationRateHigh
        expr: rate(itn_invariant_violations_total[5m]) > 0.01
        for: 2m
        labels:
          severity: critical
          component: enforcement
        annotations:
          summary: "High rate of invariant violations"
          description: "{{ $value }} violations per second. System may be under attack or misconfigured."
      
      # Settlement failures
      - alert: SettlementFailureRateHigh
        expr: rate(itn_settlements_failed_total[5m]) / rate(itn_settlements_total[5m]) > 0.001
        for: 5m
        labels:
          severity: critical
          component: settlement
        annotations:
          summary: "Settlement failure rate above 0.1%"
          description: "{{ $value | humanizePercentage }} of settlements failing. Check settlement rails."
      
      # Settlement latency
      - alert: SettlementLatencyHigh
        expr: histogram_quantile(0.99, rate(itn_settlement_duration_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: settlement
        annotations:
          summary: "P99 settlement latency exceeds 5 seconds"
          description: "P99 latency is {{ $value }}s. Violates INV-201 SLA."
      
      # Ledger imbalance
      - alert: LedgerImbalance
        expr: abs(itn_ledger_credits_total - itn_ledger_debits_total) > 0.01
        for: 1m
        labels:
          severity: critical
          component: ledger
        annotations:
          summary: "Ledger credits and debits not balanced"
          description: "Imbalance: ${{ $value }}. Critical accounting error - INV-501 violation."
      
      # Double payment detection
      - alert: DoublePaymentDetected
        expr: increase(itn_double_payment_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: settlement
        annotations:
          summary: "Double payment attempt detected"
          description: "{{ $value }} double payment attempts in last 5 minutes. INV-006 prevented."
      
      # Fraud score violations
      - alert: HighFraudScoreSettlement
        expr: increase(itn_high_fraud_settlements_blocked_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: fraud
        annotations:
          summary: "High number of fraud blocks"
          description: "{{ $value }} invoices blocked for high fraud score. Investigate pattern."

  - name: InstantTrade Performance
    interval: 30s
    rules:
      # API latency
      - alert: APILatencyHigh
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API P95 latency above 1 second"
          description: "P95 latency: {{ $value }}s. Users experiencing slow responses."
      
      # Database connections
      - alert: DatabaseConnectionPoolExhausted
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool near capacity"
          description: "{{ $value | humanizePercentage }} of connections in use."
      
      # Rate limiting
      - alert: RateLimitViolationsHigh
        expr: rate(itn_rate_limit_violations_total[5m]) > 10
        for: 5m
        labels:
          severity: info
          component: api
        annotations:
          summary: "High rate of rate limit violations"
          description: "{{ $value }} violations/s. May indicate abuse."

  - name: InstantTrade Availability
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="itn-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "InstantTrade API is down"
          description: "API service not responding to health checks."
      
      - alert: DatabaseDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL is down"
          description: "Database not responding."

---
# ============================================
# GRAFANA DASHBOARD - SYSTEM OVERVIEW
# ============================================
# File: monitoring/grafana/dashboards/system-overview.json
{
  "dashboard": {
    "title": "InstantTrade Network - System Overview",
    "tags": ["instanttrade", "overview"],
    "timezone": "browser",
    "refresh": "10s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "panels": [
      {
        "id": 1,
        "title": "System Health Score",
        "type": "gauge",
        "targets": [
          {
            "expr": "itn_health_score",
            "legendFormat": "Health Score"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "min": 0,
            "max": 1,
            "thresholds": {
              "steps": [
                {"value": 0, "color": "red"},
                {"value": 0.90, "color": "yellow"},
                {"value": 0.95, "color": "green"}
              ]
            },
            "unit": "percentunit"
          }
        },
        "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Invariant Checks (Total)",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(itn_invariant_checks_total)",
            "legendFormat": "Total Checks"
          }
        ],
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0}
      },
      {
        "id": 3,
        "title": "Invariant Violations",
        "type": "stat",
        "targets": [
          {
            "expr": "sum(itn_invariant_violations_total)",
            "legendFormat": "Violations"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "color": {"mode": "thresholds"},
            "thresholds": {
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 1, "color": "yellow"},
                {"value": 10, "color": "red"}
              ]
            }
          }
        },
        "gridPos": {"h": 4, "w": 6, "x": 6, "y": 4}
      },
      {
        "id": 4,
        "title": "Active Invoices by Status",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum by (status) (itn_invoices_by_status)",
            "legendFormat": "{{status}}"
          }
        ],
        "gridPos": {"h": 8, "w": 6, "x": 12, "y": 0}
      },
      {
        "id": 5,
        "title": "Settlement Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(itn_settlements_total[5m])",
            "legendFormat": "Settlements/sec"
          }
        ],
        "gridPos": {"h": 8, "w": 6, "x": 18, "y": 0}
      },
      {
        "id": 6,
        "title": "Settlement Latency (P50, P95, P99)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(itn_settlement_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(itn_settlement_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(itn_settlement_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ],
        "yaxes": [
          {"format": "s", "label": "Latency"}
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
      },
      {
        "id": 7,
        "title": "Ledger Balance",
        "type": "graph",
        "targets": [
          {
            "expr": "itn_ledger_credits_total",
            "legendFormat": "Credits"
          },
          {
            "expr": "itn_ledger_debits_total",
            "legendFormat": "Debits"
          },
          {
            "expr": "abs(itn_ledger_credits_total - itn_ledger_debits_total)",
            "legendFormat": "Imbalance"
          }
        ],
        "yaxes": [
          {"format": "currencyUSD", "label": "Amount"}
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
      },
      {
        "id": 8,
        "title": "Invariant Pass Rate by Category",
        "type": "table",
        "targets": [
          {
            "expr": "sum by (category) (rate(itn_invariant_checks_total[5m])) / sum by (category) (rate(itn_invariant_checks_total[5m]) + rate(itn_invariant_violations_total[5m]))",
            "format": "table",
            "instant": true
          }
        ],
        "transformations": [
          {
            "id": "organize",
            "options": {
              "excludeByName": {"Time": true},
              "renameByName": {
                "category": "Invariant Category",
                "Value": "Pass Rate"
              }
            }
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}
      },
      {
        "id": 9,
        "title": "Top 10 Failed Invariants",
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, sum by (invariant_id) (increase(itn_invariant_violations_total[1h])))",
            "format": "table",
            "instant": true
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16}
      }
    ]
  }
}

---
# ============================================
# GRAFANA DASHBOARD - ENFORCEMENT DETAILS
# ============================================
# File: monitoring/grafana/dashboards/enforcement.json
{
  "dashboard": {
    "title": "InstantTrade Network - Invariant Enforcement",
    "tags": ["instanttrade", "invariants"],
    "panels": [
      {
        "id": 1,
        "title": "Critical Invariants Status",
        "type": "table",
        "targets": [
          {
            "expr": "itn_invariant_status{criticality=\"CRITICAL\"}",
            "format": "table",
            "instant": true
          }
        ],
        "gridPos": {"h": 12, "w": 24, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "INV-001: Unique Invoice IDs",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(itn_invariant_checks_total{invariant_id=\"inv_001_unique_invoice_ids\"}[5m])",
            "legendFormat": "Checks"
          },
          {
            "expr": "rate(itn_invariant_violations_total{invariant_id=\"inv_001_unique_invoice_ids\"}[5m])",
            "legendFormat": "Violations"
          }
        ],
        "gridPos": {"h": 6, "w": 8, "x": 0, "y": 12}
      },
      {
        "id": 3,
        "title": "INV-006: Settlement Exactly Once",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(itn_invariant_checks_total{invariant_id=\"inv_006_settlement_once\"}[5m])",
            "legendFormat": "Checks"
          },
          {
            "expr": "rate(itn_invariant_violations_total{invariant_id=\"inv_006_settlement_once\"}[5m])",
            "legendFormat": "Violations (Double Payment Attempts)"
          }
        ],
        "gridPos": {"h": 6, "w": 8, "x": 8, "y": 12}
      },
      {
        "id": 4,
        "title": "INV-201: Settlement Speed (<5s)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, rate(itn_settlement_duration_seconds_bucket[5m]))",
            "legendFormat": "P99 Latency"
          }
        ],
        "yaxes": [
          {
            "format": "s",
            "max": 5,
            "label": "Duration (seconds)"
          }
        ],
        "thresholds": [
          {
            "value": 5,
            "colorMode": "critical",
            "op": "gt",
            "fill": true,
            "line": true
          }
        ],
        "gridPos": {"h": 6, "w": 8, "x": 16, "y": 12}
      }
    ]
  }
}

---
# ============================================
# CUSTOM METRICS (Application Code)
# ============================================
# File: src/metrics.py
"""
Prometheus metrics for InstantTrade Network.
All invariants and business metrics exposed.
"""

from prometheus_client import Counter, Histogram, Gauge, Info
from functools import wraps
import time

# System health
health_score = Gauge(
    'itn_health_score',
    'Overall system health score (0.0-1.0)'
)

# Invariant enforcement
invariant_checks = Counter(
    'itn_invariant_checks_total',
    'Total invariant checks executed',
    ['invariant_id', 'check_type', 'criticality']
)

invariant_violations = Counter(
    'itn_invariant_violations_total',
    'Total invariant violations detected',
    ['invariant_id', 'check_type', 'criticality']
)

invariant_status = Gauge(
    'itn_invariant_status',
    'Current status of invariant (1=pass, 0=fail)',
    ['invariant_id', 'criticality']
)

# Invoices
invoices_created = Counter(
    'itn_invoices_created_total',
    'Total invoices created',
    ['supplier_id']
)

invoices_by_status = Gauge(
    'itn_invoices_by_status',
    'Current invoices by status',
    ['status']
)

invoice_amount = Histogram(
    'itn_invoice_amount_dollars',
    'Invoice amounts in USD',
    buckets=[100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000, 10000000]
)

# Settlements
settlements_total = Counter(
    'itn_settlements_total',
    'Total settlement attempts',
    ['status']
)

settlements_failed = Counter(
    'itn_settlements_failed_total',
    'Total failed settlements'
)

settlement_duration = Histogram(
    'itn_settlement_duration_seconds',
    'Settlement duration in seconds',
    buckets=[0.1, 0.5, 1.0, 2.0, 3.0, 4.0, 5.0, 10.0]
)

double_payment_attempts = Counter(
    'itn_double_payment_attempts_total',
    'Number of double payment attempts blocked by INV-006'
)

# Ledger
ledger_credits = Gauge(
    'itn_ledger_credits_total',
    'Total credits in ledger (USD)'
)

ledger_debits = Gauge(
    'itn_ledger_debits_total',
    'Total debits in ledger (USD)'
)

ledger_balanced = Gauge(
    'itn_ledger_balanced',
    'Whether ledger is balanced (1=yes, 0=no)'
)

# Fraud detection
high_fraud_settlements_blocked = Counter(
    'itn_high_fraud_settlements_blocked_total',
    'Settlements blocked due to fraud score >0.75'
)

# Rate limiting
rate_limit_violations = Counter(
    'itn_rate_limit_violations_total',
    'Rate limit violations',
    ['account_id', 'endpoint']
)

# API performance
http_request_duration = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint', 'status_code']
)

# Decorator for tracking settlement duration
def track_settlement_duration(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        try:
            result = func(*args, **kwargs)
            duration = time.time() - start
            settlement_duration.observe(duration)
            settlements_total.labels(status='COMPLETED').inc()
            return result
        except Exception as e:
            settlements_failed.inc()
            settlements_total.labels(status='FAILED').inc()
            raise
    return wrapper

# Decorator for tracking invariant checks
def track_invariant_check(invariant_id: str, check_type: str, criticality: str):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            result = func(*args, **kwargs)
            invariant_checks.labels(
                invariant_id=invariant_id,
                check_type=check_type,
                criticality=criticality
            ).inc()
            
            if not result:
                invariant_violations.labels(
                    invariant_id=invariant_id,
                    check_type=check_type,
                    criticality=criticality
                ).inc()
                invariant_status.labels(
                    invariant_id=invariant_id,
                    criticality=criticality
                ).set(0)
            else:
                invariant_status.labels(
                    invariant_id=invariant_id,
                    criticality=criticality
                ).set(1)
            
            return result
        return wrapper
    return decorator

---
# ============================================
# SLO DEFINITIONS (Service Level Objectives)
# ============================================
# File: monitoring/slo.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: itn-slo
  namespace: instanttrade
data:
  slo.yml: |
    # InstantTrade Network SLOs
    
    availability:
      target: 99.95%  # 21.6 minutes downtime per month
      measurement_window: 30d
      
    settlement_latency:
      p99_target: 5s
      measurement_window: 1d
      alert_threshold: 5.5s
      
    health_score:
      target: 0.95
      measurement_window: 1h
      alert_threshold: 0.93
      
    ledger_accuracy:
      target: 100%  # Zero tolerance for imbalance
      measurement_window: 1h
      
    double_payment_prevention:
      target: 100%  # Must block all attempts
      measurement_window: 1d
      
    fraud_detection:
      target: 100%  # Must block all fraud_score >0.75
      measurement_window: 1d

---
# ============================================
# ALERTMANAGER CONFIGURATION
# ============================================
# File: monitoring/alertmanager.yml
global:
  resolve_timeout: 5m
  slack_api_url: '{{ .Values.slack.webhook }}'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

route:
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  
  routes:
    # Critical alerts go to PagerDuty
    - match:
        severity: critical
      receiver: 'pagerduty'
      continue: true
    
    # All alerts go to Slack
    - match_re:
        severity: critical|warning
      receiver: 'slack'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alertmanager-webhook:5001/'
  
  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: '{{ .Values.pagerduty.serviceKey }}'
        description: '{{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
  
  - name: 'slack'
    slack_configs:
      - channel: '#instanttrade-alerts'
        title: '{{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'component']
