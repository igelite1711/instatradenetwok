# ============================================
# FILE: monitoring/prometheus.yml
# ============================================
---
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'instanttrade-prod'
    environment: 'production'

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules
rule_files:
  - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # InstantTrade API metrics
  - job_name: 'itn-api'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - instanttrade
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: itn-api
        action: keep
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
    metrics_path: /metrics
    scrape_interval: 10s

  # PostgreSQL metrics
  - job_name: 'postgres'
    static_configs:
      - targets:
          - postgres-exporter:9187

  # Node exporter (system metrics)
  - job_name: 'node'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - source_labels: [__address__]
        regex: ^(.*):\d+$
        target_label: __address__
        replacement: $1:9100

---
# FILE: monitoring/rules/alerts.yml
# ============================================
---
groups:
  - name: instanttrade_critical
    interval: 30s
    rules:
      # Settlement latency alert
      - alert: HighSettlementLatency
        expr: histogram_quantile(0.99, itn_settlement_duration_seconds_bucket) > 5
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Settlement latency exceeds 5 seconds (G1 violation)"
          description: "P99 settlement latency is {{ $value }}s, exceeding 5s SLA"

      # Health score alert
      - alert: LowSystemHealth
        expr: itn_system_health_score < 0.95
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "System health below operational threshold"
          description: "Health score is {{ $value }}, threshold is 0.95"

      # Ledger imbalance alert
      - alert: LedgerImbalance
        expr: abs(itn_ledger_balance_variance_dollars) > 0.01
        for: 1m
        labels:
          severity: critical
          team: finance
        annotations:
          summary: "Ledger credits != debits (INV-501 violation)"
          description: "Ledger variance is ${{ $value }}, should be ~$0"

      # Ledger integrity alert
      - alert: LedgerIntegrityBreach
        expr: itn_ledger_integrity == 0
        for: 1m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "CRITICAL: Ledger tampering detected"
          description: "Ledger chain integrity check failed - possible tampering"

  - name: instanttrade_important
    interval: 1m
    rules:
      # Invariant violation rate
      - alert: HighInvariantViolationRate
        expr: rate(itn_invariant_violations_total[5m]) > 0.01
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High rate of invariant violations"
          description: "{{ $value }} violations/sec in last 5 minutes"

      # Settlement success rate
      - alert: LowSettlementSuccessRate
        expr: |
          (
            rate(itn_settlements_completed_total[5m]) /
            (rate(itn_settlements_completed_total[5m]) + rate(itn_settlements_failed_total[5m]))
          ) < 0.999
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Settlement success rate below 99.9%"
          description: "Success rate is {{ $value | humanizePercentage }}"

      # API error rate
      - alert: HighAPIErrorRate
        expr: |
          rate(itn_api_requests_total{status_code=~"5.."}[5m]) /
          rate(itn_api_requests_total[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High API error rate"
          description: "{{ $value | humanizePercentage }} of requests failing"

  - name: instanttrade_business
    interval: 5m
    rules:
      # Capital competition rate
      - alert: LowCapitalCompetition
        expr: itn_capital_competition_rate < 0.70
        for: 1h
        labels:
          severity: warning
          team: business
        annotations:
          summary: "Low capital provider competition"
          description: "Only {{ $value | humanizePercentage }} of invoices have 3+ bids"

      # Fraud score monitoring
      - alert: HighFraudActivity
        expr: rate(itn_fraud_score_bucket{le="0.75"}[1h]) < 0.95
        for: 30m
        labels:
          severity: warning
          team: risk
        annotations:
          summary: "Elevated fraud activity detected"
          description: "{{ $value | humanizePercentage }} of invoices below fraud threshold"

---
# FILE: Dockerfile
# ============================================
---
FROM python:3.11-slim as base

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Create app user
RUN useradd -m -u 1000 itn && \
    mkdir -p /app && \
    chown -R itn:itn /app

WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY --chown=itn:itn src/ ./src/
COPY --chown=itn:itn *.py ./

# Switch to non-root user
USER itn

# Expose ports
EXPOSE 8000 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=5)"

# Run application
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]

---
# FILE: docker-compose.yml
# ============================================
---
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: instanttrade
      POSTGRES_USER: itn_user
      POSTGRES_PASSWORD: itn_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U itn_user -d instanttrade"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build: .
    ports:
      - "8000:8000"
      - "9090:9090"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: instanttrade
      DB_USER: itn_user
      DB_PASSWORD: itn_password
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SYSTEM_SECRET: dev_secret_key_change_in_prod
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./*.py:/app/
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/rules:/etc/prometheus/rules
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:

---
# FILE: Makefile
# ============================================
---
.PHONY: help install dev test lint format docker-build docker-up docker-down k8s-deploy clean

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Available targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)

install: ## Install dependencies
	pip install -r requirements.txt
	pip install -r requirements-dev.txt

dev: ## Run development server
	docker-compose up -d postgres redis
	uvicorn main:app --reload --host 0.0.0.0 --port 8000

test: ## Run tests
	pytest tests/ -v --cov=src --cov-report=html --cov-report=term

test-integration: ## Run integration tests
	pytest tests/integration/ -v

lint: ## Run linters
	flake8 src/ tests/
	mypy src/
	black --check src/ tests/

format: ## Format code
	black src/ tests/
	isort src/ tests/

docker-build: ## Build Docker image
	docker build -t instanttrade/api:latest .

docker-up: ## Start all services with Docker Compose
	docker-compose up -d

docker-down: ## Stop all services
	docker-compose down

docker-logs: ## View logs
	docker-compose logs -f api

docker-shell: ## Open shell in API container
	docker-compose exec api /bin/bash

k8s-apply: ## Apply Kubernetes manifests
	kubectl apply -f k8s/namespace.yaml
	kubectl apply -f k8s/configmap.yaml
	kubectl apply -f k8s/secrets.yaml
	kubectl apply -f k8s/database-statefulset.yaml
	kubectl apply -f k8s/api-deployment.yaml
	kubectl apply -f k8s/api-service.yaml
	kubectl apply -f k8s/ingress.yaml
	kubectl apply -f k8s/hpa.yaml

k8s-delete: ## Delete Kubernetes resources
	kubectl delete namespace instanttrade

k8s-logs: ## View API logs in Kubernetes
	kubectl logs -n instanttrade -l app=itn-api -f

k8s-status: ## Check Kubernetes resources status
	kubectl get all -n instanttrade

db-migrate: ## Run database migrations
	docker-compose exec postgres psql -U itn_user -d instanttrade -f /docker-entrypoint-initdb.d/01-schema.sql

db-seed: ## Seed database
	docker-compose exec postgres psql -U itn_user -d instanttrade -f /docker-entrypoint-initdb.d/02-seed.sql

db-shell: ## Open PostgreSQL shell
	docker-compose exec postgres psql -U itn_user -d instanttrade

metrics: ## Open Prometheus UI
	open http://localhost:9091

grafana: ## Open Grafana UI
	open http://localhost:3000

clean: ## Clean up generated files
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache .mypy_cache .coverage htmlcov/

---
# FILE: .github/workflows/deploy.yml
# ============================================
---
name: Deploy InstantTrade Network

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: instanttrade_test
          POSTGRES_USER: itn_test
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Lint
        run: |
          flake8 src/ tests/
          black --check src/ tests/
          mypy src/

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: instanttrade_test
          DB_USER: itn_test
          DB_PASSWORD: test_password

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Deploy to staging
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/secrets.yaml
          kubectl apply -f k8s/
          kubectl rollout status deployment/itn-api -n instanttrade --timeout=5m

      - name: Run smoke tests
        run: |
          export API_URL=$(kubectl get ingress -n instanttrade itn-ingress -o jsonpath='{.spec.rules[0].host}')
          curl -f https://$API_URL/health || exit 1

  deploy-production:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v3

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_PROD }}

      - name: Deploy to production
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/itn-api -n instanttrade --timeout=10m

      - name: Health check
        run: |
          export API_URL=$(kubectl get ingress -n instanttrade itn-ingress -o jsonpath='{.spec.rules[0].host}')
          curl -f https://$API_URL/health || exit 1

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
